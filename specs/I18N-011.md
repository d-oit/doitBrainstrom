# specs/I18N-011.md

## Phase 11: Internationalization (I18N-011)

**Functional Requirements:**

1.  **I18n Framework Integration:** Set up and configure a robust internationalization framework (e.g., i18next, React-Intl) for managing translations.
2.  **Translation Management:** Implement a system for managing and loading translations for different languages.
3.  **Language Selection:** Create a language switcher component that allows users to change the application language.
4.  **RTL Support:** Add support for right-to-left (RTL) languages where text flows from right to left.
5.  **Date/Time Formatting:** Implement locale-aware date and time formatting.
6.  **Number Formatting:** Add support for locale-specific number formatting.
7.  **Translation Integration:** Integrate translations into all user-facing text throughout the application.
8.  **Language Detection:** Implement automatic language detection based on browser settings.

**Edge Cases:**

1.  **Missing Translations:** Handle cases where translations are missing for certain languages.
2.  **Loading Errors:** Handle errors during translation file loading.
3.  **RTL Layout Issues:** Address layout problems when switching between LTR and RTL languages.
4.  **Font Support:** Handle cases where selected fonts don't support certain language characters.
5.  **Dynamic Content:** Ensure dynamic content (e.g., mind map nodes) supports internationalization.
6.  **Pluralization:** Handle complex pluralization rules for different languages.
7.  **Fallback Languages:** Implement fallback chains for unsupported languages.
8.  **Performance Impact:** Address potential performance issues with loading multiple language files.

**Constraints:**

1.  **Use a standardized i18n framework.**
2.  **Support both LTR and RTL text directions.**
3.  **Implement language detection and selection.**
4.  **Handle dates, numbers, and currencies according to locale.**

**Pseudocode:**

```pseudocode
// Module: internationalization.ts

// Function: setupI18nFramework
// Sets up the i18n framework (e.g., i18next)
function setupI18nFramework(): Result<Success, Error> {
  // Vitest test example:
  // describe('i18n Framework Setup', () => {
  //   it('should initialize i18next with correct configuration', () => {
  //     const result = setupI18nFramework();
  //     expect(result.isSuccess()).toBe(true);
  //
  //     expect(i18n.options.fallbackLng).toBe('en');
  //     expect(i18n.options.supportedLngs).toContain('ar');
  //     expect(i18n.options.backend.loadPath).toBe('/locales/{{lng}}/{{ns}}.json');
  //   });
  //
  //   it('should load translations for default language', async () => {
  //     await i18n.changeLanguage('en');
  //     expect(i18n.t('common.mindMap')).toBe('Mind Map');
  //     expect(i18n.t('common.addNode')).toBe('Add Node');
  //   });
  // });

  log("Setting up i18n framework...");
  execute_command("npm install i18next react-i18next i18next-http-backend i18next-browser-languagedetector");
  if (command_successful) {
    i18n_config_content = `
      // src/i18n.ts
      import i18n from 'i18next';
      import { initReactI18next } from 'react-i18next';
      import LanguageDetector from 'i18next-browser-languagedetector';
      import Backend from 'i18next-http-backend';

      i18n
        .use(Backend)
        .use(LanguageDetector)
        .use(initReactI18next)
        .init({
          fallbackLng: 'en',
          debug: process.env.NODE_ENV === 'development',
          interpolation: {
            escapeValue: false,
          },
          supportedLngs: ['en', 'de', 'es', 'fr', 'ar'],
          backend: {
            loadPath: '/locales/{{lng}}/{{ns}}.json',
          },
        });

      export default i18n;
    `;
    write_to_file("src/i18n.ts", i18n_config_content);
    log("I18n framework setup successful.");
    return Success;
  } else {
    log_error("I18n framework setup failed.");
    return Error("I18n framework setup failed.");
  }
}

// Function: implementLanguageSwitcher
// Implements the language switcher component
function implementLanguageSwitcher(): Result<Success, Error> {
  // Vitest test example:
  // describe('LanguageSwitcher Component', () => {
  //   it('should render all supported languages', () => {
  //     render(<LanguageSwitcher />);
  //     const select = screen.getByLabelText('Language');
  //     fireEvent.mouseDown(select);
  //
  //     expect(screen.getByText('English')).toBeInTheDocument();
  //     expect(screen.getByText('العربية')).toBeInTheDocument();
  //   });
  //
  //   it('should change language and direction', async () => {
  //     render(<LanguageSwitcher />);
  //     const select = screen.getByLabelText('Language');
  //
  //     // Change to Arabic
  //     await userEvent.click(select);
  //     await userEvent.click(screen.getByText('العربية'));
  //
  //     expect(document.documentElement.dir).toBe('rtl');
  //     expect(i18n.language).toBe('ar');
  //   });
  // });

  log("Implementing language switcher component...");
  language_switcher_content = `
    // src/components/LanguageSwitcher.tsx
    import React from 'react';
    import { useTranslation } from 'react-i18next';
    import { Select, MenuItem, FormControl, InputLabel } from '@mui/material';

    const LanguageSwitcher: React.FC = () => {
      const { i18n } = useTranslation();

      const languages = [
        { code: 'en', name: 'English' },
        { code: 'de', name: 'Deutsch' },
        { code: 'es', name: 'Español' },
        { code: 'fr', name: 'Français' },
        { code: 'ar', name: 'العربية' },
      ];

      const handleChange = (event: React.ChangeEvent<{ value: unknown }>) => {
        const langCode = event.target.value as string;
        i18n.changeLanguage(langCode);
        document.documentElement.dir = langCode === 'ar' ? 'rtl' : 'ltr';
      };

      return (
        <FormControl variant="outlined" size="small">
          <InputLabel id="language-select-label">Language</InputLabel>
          <Select
            labelId="language-select-label"
            value={i18n.language}
            onChange={handleChange}
            label="Language"
          >
            {languages.map((lang) => (
              <MenuItem key={lang.code} value={lang.code}>
                {lang.name}
              </MenuItem>
            ))}
          </Select>
        </FormControl>
      );
    };

    export default LanguageSwitcher;
  `;
  write_to_file("src/components/LanguageSwitcher.tsx", language_switcher_content);
  if (file_write_successful) {
    log("Language switcher component implemented.");
    return Success;
  } else {
    log_error("Language switcher implementation failed.");
    return Error("Language switcher implementation failed.");
  }
}

// Function: setupTranslationFiles
// Sets up basic translation files structure
function setupTranslationFiles(): Result<Success, Error> {
  // Vitest test example:
  // describe('Translation Files Setup', () => {
  //   it('should create translation files for all supported languages', async () => {
  //     const result = await setupTranslationFiles();
  //     expect(result.isSuccess()).toBe(true);
  //
  //     // Verify English translations
  //     const enTranslations = JSON.parse(await fs.readFile('public/locales/en/translation.json', 'utf8'));
  //     expect(enTranslations.common.mindMap).toBe('Mind Map');
  //
  //     // Verify directory structure
  //     const localesDir = await fs.readdir('public/locales');
  //     expect(localesDir).toContain('en');
  //     expect(localesDir).toContain('ar');
  //   });
  //
  //   it('should handle missing translations gracefully', async () => {
  //     await i18n.changeLanguage('fr');
  //     // Should fallback to English for missing translations
  //     expect(i18n.t('common.mindMap')).toBe('Mind Map');
  //   });
  // });

  log("Setting up translation files...");
  create_directory("public/locales/en");
  create_directory("public/locales/de");
  create_directory("public/locales/es");
  create_directory("public/locales/fr");
  create_directory("public/locales/ar");

  translation_en = `{
    "common": {
      "mindMap": "Mind Map",
      "addNode": "Add Node",
      "editNode": "Edit Node",
      "deleteNode": "Delete Node",
      "save": "Save",
      "cancel": "Cancel",
      "loading": "Loading...",
      "error": "Error",
      "success": "Success"
    },
    "theme": {
      "light": "Light",
      "dark": "Dark",
      "system": "System"
    },
    "errors": {
      "nodeCreation": "Error creating node",
      "nodeDeletion": "Error deleting node",
      "nodeUpdate": "Error updating node",
      "networkError": "Network error",
      "syncError": "Synchronization error"
    }
  }`;

  write_to_file("public/locales/en/translation.json", translation_en);
  // Similar files would be created for other languages

  if (file_write_successful) {
    log("Translation files structure set up.");
    return Success;
  } else {
    log_error("Translation files setup failed.");
    return Error("Translation files setup failed.");
  }
}

// Function: implementRTLSupport
// Implements RTL support in the application
function implementRTLSupport(): Result<Success, Error> {
  // Vitest test example:
  // describe('RTL Support', () => {
  //   it('should set correct direction based on language', () => {
  //     const { setDirection, isRTL } = require('./rtlUtils');
  //
  //     // Test LTR language
  //     setDirection('en');
  //     expect(document.documentElement.dir).toBe('ltr');
  //     expect(isRTL('en')).toBe(false);
  //
  //     // Test RTL language
  //     setDirection('ar');
  //     expect(document.documentElement.dir).toBe('rtl');
  //     expect(isRTL('ar')).toBe(true);
  //   });
  //
  //   it('should apply RTL styles correctly', () => {
  //     render(
  //       <ThemeProvider>
  //         <div data-testid="rtl-test">Test Content</div>
  //       </ThemeProvider>
  //     );
  //
  //     i18n.changeLanguage('ar');
  //     const element = screen.getByTestId('rtl-test');
  //     const styles = window.getComputedStyle(element);
  //     expect(styles.direction).toBe('rtl');
  //   });
  // });

  log("Implementing RTL support...");
  rtl_utils_content = `
    // src/utils/rtlUtils.ts
    export const setDirection = (lang: string) => {
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
    };

    export const isRTL = (lang: string) => {
      return lang === 'ar';
    };
  `;
  write_to_file("src/utils/rtlUtils.ts", rtl_utils_content);

  // Update theme context to handle RTL
  theme_context_update = `
    // src/contexts/ThemeContext.tsx update
    const getTheme = (mode: ThemeMode, isRTL: boolean) => {
      // ... existing theme logic ...
      return createTheme({
        palette: {
          mode: themeMode,
        },
        direction: isRTL ? 'rtl' : 'ltr',
      });
    };
  `;

  if (file_write_successful) {
    log("RTL support implemented.");
    return Success;
  } else {
    log_error("RTL support implementation failed.");
    return Error("RTL support implementation failed.");
  }
}

// Function: implementLocaleFormatting
// Implements locale-aware date, time, and number formatting
function implementLocaleFormatting(): Result<Success, Error> {
  // Vitest test example:
  // describe('Locale Formatting', () => {
  //   it('should format dates according to locale', () => {
  //     const date = new Date('2025-03-31');
  //
  //     expect(formatDate(date, 'en')).toBe('Mar 31, 2025');
  //     expect(formatDate(date, 'de')).toBe('31.03.2025');
  //     expect(formatDate(date, 'ar')).toBe('٣١ مارس ٢٠٢٥');
  //   });
  //
  //   it('should format numbers according to locale', () => {
  //     const number = 1234567.89;
  //
  //     expect(formatNumber(number, 'en')).toBe('1,234,567.89');
  //     expect(formatNumber(number, 'de')).toBe('1.234.567,89');
  //     expect(formatNumber(number, 'ar')).toBe('١٬٢٣٤٬٥٦٧٫٨٩');
  //   });
  //
  //   it('should format currency according to locale', () => {
  //     const amount = 99.99;
  //
  //     expect(formatCurrency(amount, 'en', 'USD')).toBe('$99.99');
  //     expect(formatCurrency(amount, 'de', 'EUR')).toBe('99,99 €');
  //     expect(formatCurrency(amount, 'ar', 'SAR')).toBe('٩٩٫٩٩ ر.س.‏');
  //   });
  // });

  log("Implementing locale-aware formatting...");
  formatting_utils_content = `
    // src/utils/formatUtils.ts
    export const formatDate = (date: Date, locale: string) => {
      return new Intl.DateTimeFormat(locale).format(date);
    };

    export const formatNumber = (num: number, locale: string) => {
      return new Intl.NumberFormat(locale).format(num);
    };

    export const formatCurrency = (amount: number, locale: string, currency: string) => {
      return new Intl.NumberFormat(locale, {
        style: 'currency',
        currency,
      }).format(amount);
    };
  `;
  write_to_file("src/utils/formatUtils.ts", formatting_utils_content);

  if (file_write_successful) {
    log("Locale-aware formatting implemented.");
    return Success;
  } else {
    log_error("Locale-aware formatting implementation failed.");
    return Error("Locale-aware formatting implementation failed.");
  }
}

// Function: runSetupPhase11
// Orchestrates all i18n setup steps
function runSetupPhase11(): Result<Success, AggregateError> {
  log("Starting Phase 11 Setup: Internationalization");
  results = [];

  result = setupI18nFramework();
  results.push(result);
  if (result is Error) { log_error("I18n framework setup failed."); }

  result = implementLanguageSwitcher();
  results.push(result);
  if (result is Error) { log_error("Language switcher implementation failed."); }

  result = setupTranslationFiles();
  results.push(result);
  if (result is Error) { log_error("Translation files setup failed."); }

  result = implementRTLSupport();
  results.push(result);
  if (result is Error) { log_error("RTL support implementation failed."); }

  result = implementLocaleFormatting();
  results.push(result);
  if (result is Error) { log_error("Locale formatting implementation failed."); }

  if (all_results_successful(results)) {
    log("Phase 11 Setup: Internationalization completed successfully.");
    return Success;
  } else {
    log_error("Phase 11 Setup: Internationalization completed with issues.");
    return AggregateError(results);
  }
}

runSetupPhase11();